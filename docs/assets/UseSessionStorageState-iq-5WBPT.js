import{r as n,j as t}from"./index-7iLlK_Uu.js";import{u as w}from"./useEvents-zliC5Uda.js";import{u as R}from"./useMemoizedFn-wpIxtp5q.js";function f({key:e,initialState:s,opts:u}){const[j,g]=w(),l=n.useRef((u==null?void 0:u.serializer)||JSON.stringify),S=n.useRef((u==null?void 0:u.deserializer)||JSON.parse),a=n.useRef((u==null?void 0:u.mode)||"read/write"),c=n.useRef(n.useMemo(()=>{if(a.current==="write")return null;const r=sessionStorage.getItem(e);if(r!=null)return S.current(r);if(s){const o=s instanceof Function?s():s;return sessionStorage.setItem(e,l.current(o)),o}else return null},[])),p=n.useRef(r=>{const o=i=>{i.type==="storage"&&i.storageArea!==sessionStorage||a.current==="write"||(i instanceof CustomEvent?i.detail.key===e&&r():i.key===e&&r())};window.addEventListener("storage",o,{passive:!0});const v=j("ssn-strg",o);return()=>{window.removeEventListener("storage",o),v()}}),E=n.useRef(()=>{const r=sessionStorage.getItem(e)??"null",o=l.current(c.current);return r!==o&&(c.current=r!==null?S.current(r):null),c.current}),x=n.useSyncExternalStore(p.current,E.current),h=n.useRef(r=>{const o=l.current(r instanceof Function?r(c.current):r);sessionStorage.setItem(e,o),g(new CustomEvent("ssn-strg",{detail:{key:e}}))}),d=n.useRef(()=>{sessionStorage.removeItem(e),g(new CustomEvent("ssn-strg",{detail:{key:e}}))}),m=R(()=>c.current);return a.current==="read"?[x,m,d.current]:a.current==="write"?[h.current,m,d.current]:[x,h.current,m,d.current]}const C=()=>{const[e]=f({key:"demo",opts:{mode:"read"}});return t.jsxs(t.Fragment,{children:[t.jsx("h3",{children:"Child component 1"}),t.jsxs("p",{children:["State is ",e]})]})},b=()=>{const[e]=f({key:"demo",opts:{mode:"write"}});return t.jsxs(t.Fragment,{children:[t.jsx("h3",{children:"Child component 2"}),t.jsx("form",{onSubmit:s=>{e(s.target[0].value),s.preventDefault()},children:t.jsx("input",{type:"text"})})]})},F=()=>{const[,,,e]=f({key:"demo",initialState:"prova"}),s=n.useCallback(()=>e(),[e]);return n.useEffect(()=>()=>{s()},[s]),t.jsxs(t.Fragment,{children:[t.jsx(C,{}),t.jsx("br",{}),t.jsx(b,{})]})};F.displayName="UseSessionStorageState";export{F as UseSessionStorageState};
