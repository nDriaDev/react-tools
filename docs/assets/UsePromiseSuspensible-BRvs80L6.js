import{r as l,j as c}from"./index-27nyValZ.js";import{E as f}from"./ErrorBoundary-kY0zT0Xr.js";import{u as m}from"./useEffectOnce-DHwcJzMV.js";import{i as h}from"./isDeepEqual-ugfbRWzt.js";const a=new Map;function w(i,o,r={}){let n=r.identifier??String.raw`${i.toString()}`;const[,u]=l.useReducer(t=>t+1e-11,0),d=l.useRef(()=>{a.delete(n)&&u()});m(()=>()=>{if(r.cache==="unmount")a.delete(n);else{const t=a.get(n);let e=setInterval(()=>{(!t||t&&Date.now()>t.cache)&&(a.delete(n),clearInterval(e))},1e3)}});for(const[t,e]of a.entries())if(h([...o,r.identifier??String.raw`${i.toString()}`],[...e.deps,e.identifier]))if(e.cache&&e.cache!=="unmount"&&Date.now()>e.cache){a.delete(t);break}else{if("error"in e)throw r.cleanOnError&&(e.errorTimeout!==-1&&clearTimeout(e.errorTimeout),e.errorTimeout=setTimeout(()=>{a.delete(t)},20)),e.error;if("response"in e)return r.invalidateManually?[e.response,d.current]:e.response;throw e.promise}const s={deps:o,identifier:r.identifier??String.raw`${i.toString()}`,cache:r.cache?r.cache==="unmount"?"unmount":Date.now()+r.cache*1e3:null,promise:i().then(t=>{s.response=t}).catch(t=>{s.error=t})};throw a.set(n,s),s.promise}const g=()=>{const[i,o]=w(async()=>await new Promise((r,n)=>{console.log("called"),setTimeout(()=>{Math.random()>.5?r([1,2,3,4,5]):n("Error throwed by promise")},4e3)}),[],{cache:25,cleanOnError:!0,identifier:"ss",invalidateManually:!0});return c.jsxs(c.Fragment,{children:[c.jsx("button",{onClick:o,children:"Invalidate"}),c.jsx("pre",{children:JSON.stringify(i)})]})},b=()=>{const i=l.useCallback((o,r,n)=>c.jsx("button",{onClick:n,children:"Retry"}),[]);return c.jsx(f,{fallback:i,children:c.jsx(l.Suspense,{fallback:"loading...",children:c.jsx(g,{})})})};export{b as UsePromiseSuspensible};
