import{r as l,j as t}from"./index-K3kjPFtB.js";const j=(d,h,m)=>{const f=l.useCallback((g,x,v)=>{const u=g??d,e=x??h,r=v??m;return!u||!e?Promise.resolve():r?navigator.locks.request(u,r,e):navigator.locks.request(u,e)},[d,h,m]),p=l.useCallback(()=>navigator.locks.query(),[]);return[f,p]},y=()=>{const[,d]=l.useState([]),[h,m]=l.useState({held:[],pending:[]}),[f,p]=l.useState({consumer:[],buffer:[],producer:[]}),g=l.useCallback(e=>new Promise(r=>{setTimeout(()=>{if(e==="read"){let c,a;d(s=>(a=s.filter((i,n,o)=>n!==o.length-1?!0:(c=i,!1)),a)),p(s=>({producer:[...s.producer,"-"].filter((i,n,o)=>o.length-n<=5),buffer:[...s.buffer,a].filter((i,n,o)=>o.length-n<=5),consumer:[...s.consumer,c!==void 0?"Consumer has read "+c:"Consumer has read nothing"].filter((i,n,o)=>o.length-n<=5)}))}else{const c=Math.floor(Math.random()*11);let a;d(s=>(a=[c,...s],a)),p(s=>({consumer:[...s.consumer,"-"].filter((i,n,o)=>o.length-n<=5),buffer:[...s.buffer,a].filter((i,n,o)=>o.length-n<=5),producer:[...s.producer,"Producer has written "+c].filter((i,n,o)=>o.length-n<=5)}))}r()},1600)}),[]),[x,v]=j("resource",async()=>{await g("read")}),[u]=j("resource",async()=>{await g("write")},{mode:"shared"});return l.useEffect(()=>{const e=setInterval(async()=>{Math.floor(Math.random()*11)<=6?x():u()},700);return()=>clearInterval(e)},[x,u]),l.useEffect(()=>{const e=setInterval(async()=>{const r=await v(),c=(r.held||[]).map(s=>`${s.mode==="exclusive"?"Reader":"Writer"} require ${s.mode} lock`),a=(r.pending||[]).map(s=>`${s.mode==="exclusive"?"Reader":"Writer"} require ${s.mode} lock`);m({held:c,pending:a})},1e3);return()=>{clearInterval(e)}},[v]),t.jsx("div",{children:t.jsxs("div",{style:{marginTop:30,display:"grid",gridTemplateColumns:"auto auto auto auto auto",justifyContent:"center",gap:50,overflow:"auto",maxHeight:400},children:[t.jsxs("div",{style:{overflow:"auto",maxHeight:400},children:[t.jsx("h3",{children:"Producer"}),f.producer.map((e,r)=>t.jsx("p",{children:e},r))]}),t.jsxs("div",{children:[t.jsx("h3",{children:"Buffer"}),f.buffer.map((e,r)=>t.jsx("p",{children:JSON.stringify(e)},r))]}),t.jsx("div",{style:{display:"grid",gridTemplateColumns:"auto",justifyContent:"center",gap:50,overflow:"auto",maxHeight:400},children:t.jsxs("div",{children:[t.jsx("h3",{children:"Consumer "}),f.consumer.map((e,r)=>t.jsx("p",{children:e},r))]})}),t.jsxs("div",{style:{overflow:"auto",maxHeight:400},children:[t.jsx("h4",{children:"Held Lock"}),h.held.map((e,r)=>t.jsx("p",{children:e},r))]}),t.jsxs("div",{style:{overflow:"auto",maxHeight:400},children:[t.jsx("h4",{children:"Pending Lock"}),h.pending.map((e,r)=>t.jsx("p",{children:e},r))]})]})})};export{y as UseLock};
