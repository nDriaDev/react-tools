import{r as n,j as r}from"./index-27nyValZ.js";import{u as w}from"./useSyncExternalStore-Atv6g5DE.js";import{u as R}from"./useEvents-BA6kAo12.js";import{u as C}from"./useMemoizedFn-BIdGgDj3.js";import{u as b}from"./useEffectOnce-DHwcJzMV.js";function f({key:e,initialState:o,opts:c}){const[p,g]=R(),i=n.useRef((c==null?void 0:c.serializer)||JSON.stringify),S=n.useRef((c==null?void 0:c.deserializer)||JSON.parse),l=n.useRef((c==null?void 0:c.mode)||"read/write"),u=n.useRef(n.useMemo(()=>{if(l.current==="write")return null;const t=localStorage.getItem(e);if(t!=null)return S.current(t);if(o){const s=o instanceof Function?o():o;return localStorage.setItem(e,i.current(s)),s}else return null},[])),j=n.useRef(t=>{const s=a=>{a.type==="storage"&&a.storageArea!==localStorage||l.current==="write"||(a instanceof CustomEvent?a.detail.key===e&&t():a.key===e&&t())};window.addEventListener("storage",s,{passive:!0});const v=p("local-strg",s);return()=>{window.removeEventListener("storage",s),v()}}),E=n.useRef(()=>{const t=localStorage.getItem(e)??"null",s=i.current(u.current);return t!==s&&(u.current=t!==null?S.current(t):null),u.current}),x=w(j.current,E.current),h=n.useRef(t=>{const s=i.current(t instanceof Function?t(u.current):t);localStorage.setItem(e,s),g(new CustomEvent("local-strg",{detail:{key:e}}))}),m=C(()=>u.current),d=n.useRef(()=>{localStorage.removeItem(e),g(new CustomEvent("local-strg",{detail:{key:e}}))});return l.current==="read"?[x,m,d.current]:l.current==="write"?[h.current,m,d.current]:[x,h.current,m,d.current]}const F=n.memo(()=>{const[e]=f({key:"demo",opts:{mode:"read"}});return r.jsxs(r.Fragment,{children:[r.jsx("h3",{children:"Child component 1"}),r.jsxs("p",{children:["State is ",e]})]})}),z=n.memo(()=>{const[e]=f({key:"demo",opts:{mode:"write"}});return r.jsxs(r.Fragment,{children:[r.jsx("h3",{children:"Child component 2"}),r.jsx("form",{onSubmit:o=>{e(o.target[0].value),o.preventDefault()},children:r.jsx("input",{type:"text"})})]})}),I=()=>{const[,,,e]=f({key:"demo",initialState:"prova"}),o=n.useCallback(()=>e(),[e]);return b(()=>()=>o()),r.jsxs(r.Fragment,{children:[r.jsx(F,{}),r.jsx("br",{}),r.jsx(z,{})]})};I.displayName="UseLocalStorageState";export{I as UseLocalStorageState};
