import{r as n,j as t}from"./index-EeM7-kOu.js";import{u as w}from"./useEvents-KhdkjBYt.js";import{u as R}from"./useMemoizedFn-MnDifN_h.js";import{u as C}from"./useEffectOnce-G9UhJmeE.js";function f({key:e,initialState:c,opts:o}){const[j,g]=w(),i=n.useRef((o==null?void 0:o.serializer)||JSON.stringify),S=n.useRef((o==null?void 0:o.deserializer)||JSON.parse),l=n.useRef((o==null?void 0:o.mode)||"read/write"),u=n.useRef(n.useMemo(()=>{if(l.current==="write")return null;const r=localStorage.getItem(e);if(r!=null)return S.current(r);if(c){const s=c instanceof Function?c():c;return localStorage.setItem(e,i.current(s)),s}else return null},[])),p=n.useRef(r=>{const s=a=>{a.type==="storage"&&a.storageArea!==localStorage||l.current==="write"||(a instanceof CustomEvent?a.detail.key===e&&r():a.key===e&&r())};window.addEventListener("storage",s,{passive:!0});const v=j("local-strg",s);return()=>{window.removeEventListener("storage",s),v()}}),E=n.useRef(()=>{const r=localStorage.getItem(e)??"null",s=i.current(u.current);return r!==s&&(u.current=r!==null?S.current(r):null),u.current}),x=n.useSyncExternalStore(p.current,E.current),h=n.useRef(r=>{const s=i.current(r instanceof Function?r(u.current):r);localStorage.setItem(e,s),g(new CustomEvent("local-strg",{detail:{key:e}}))}),m=R(()=>u.current),d=n.useRef(()=>{localStorage.removeItem(e),g(new CustomEvent("local-strg",{detail:{key:e}}))});return l.current==="read"?[x,m,d.current]:l.current==="write"?[h.current,m,d.current]:[x,h.current,m,d.current]}const b=n.memo(()=>{const[e]=f({key:"demo",opts:{mode:"read"}});return t.jsxs(t.Fragment,{children:[t.jsx("h3",{children:"Child component 1"}),t.jsxs("p",{children:["State is ",e]})]})}),F=n.memo(()=>{const[e]=f({key:"demo",opts:{mode:"write"}});return t.jsxs(t.Fragment,{children:[t.jsx("h3",{children:"Child component 2"}),t.jsx("form",{onSubmit:c=>{e(c.target[0].value),c.preventDefault()},children:t.jsx("input",{type:"text"})})]})}),z=()=>{const[,,,e]=f({key:"demo",initialState:"prova"}),c=n.useCallback(()=>e(),[e]);return C(()=>()=>c()),t.jsxs(t.Fragment,{children:[t.jsx(b,{}),t.jsx("br",{}),t.jsx(F,{})]})};z.displayName="UseLocalStorageState";export{z as UseLocalStorageState};
